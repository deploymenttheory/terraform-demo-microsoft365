name: Setup Service Principals

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'sandbox'
        type: choice
        options:
        - sandbox
        - staging
        - production

env:
  PYTHON_VERSION: '3.11'

jobs:
  setup-service-principals:
    name: Create Service Principals - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    outputs:
      service_principals: ${{ steps.create-sps.outputs.service_principals }}
    
    strategy:
      matrix:
        environment: [sandbox, staging, production]
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: scripts/service_principles/requirements.txt

      - name: Install Python dependencies
        working-directory: scripts/service_principles
        run: |
          pip install -r requirements.txt

      - name: Create service principals for ${{ matrix.environment }}
        id: create-sps
        working-directory: scripts/service_principles
        run: |
          python create_service_principals.py
        env:
          ENVIRONMENT: ${{ matrix.environment }}
          AZURE_CLIENT_ID: ${{ matrix.environment == 'sandbox' && secrets.SANDBOX_SETUP_CLIENT_ID || matrix.environment == 'staging' && secrets.STAGING_SETUP_CLIENT_ID || secrets.PRODUCTION_SETUP_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ matrix.environment == 'sandbox' && secrets.SANDBOX_SETUP_TENANT_ID || matrix.environment == 'staging' && secrets.STAGING_SETUP_TENANT_ID || secrets.PRODUCTION_SETUP_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ matrix.environment == 'sandbox' && secrets.SANDBOX_SETUP_CLIENT_SECRET || matrix.environment == 'staging' && secrets.STAGING_SETUP_CLIENT_SECRET || secrets.PRODUCTION_SETUP_CLIENT_SECRET }}

      - name: Display created service principals for ${{ matrix.environment }}
        run: |
          echo "Service Principals created for ${{ matrix.environment }}:"
          echo '${{ steps.create-sps.outputs.service_principals }}' | jq .

  use-service-principals:
    name: Use Service Principals in subsequent step
    needs: setup-service-principals
    runs-on: ubuntu-latest
    
    steps:
      - name: Parse service principal outputs
        id: parse-sps
        run: |
          echo "Parsing service principals..."
          echo '${{ needs.setup-service-principals.outputs.service_principals }}' | jq .
          
          # Extract specific service principal IDs for use in other steps
          echo "groups_client_id=$(echo '${{ needs.setup-service-principals.outputs.service_principals }}' | jq -r '.service_principals.m365_groups.client_id')" >> $GITHUB_OUTPUT
          echo "groups_object_id=$(echo '${{ needs.setup-service-principals.outputs.service_principals }}' | jq -r '.service_principals.m365_groups.object_id')" >> $GITHUB_OUTPUT
          
          echo "windows_client_id=$(echo '${{ needs.setup-service-principals.outputs.service_principals }}' | jq -r '.service_principals.m365_device_management_windows.client_id')" >> $GITHUB_OUTPUT
          echo "windows_object_id=$(echo '${{ needs.setup-service-principals.outputs.service_principals }}' | jq -r '.service_principals.m365_device_management_windows.object_id')" >> $GITHUB_OUTPUT

      - name: Example usage of service principal IDs
        run: |
          echo "Groups SP Client ID: ${{ steps.parse-sps.outputs.groups_client_id }}"
          echo "Groups SP Object ID: ${{ steps.parse-sps.outputs.groups_object_id }}"
          echo "Windows SP Client ID: ${{ steps.parse-sps.outputs.windows_client_id }}"
          echo "Windows SP Object ID: ${{ steps.parse-sps.outputs.windows_object_id }}"
          
          # These IDs can now be used to configure Terraform workspaces,
          # create secrets, or perform other automation tasks